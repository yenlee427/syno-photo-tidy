# syno-photo-tidy â€” æœ€æ–°ç‰ˆé–‹ç™¼è¨ˆç•«ï¼ˆWindows / å¯é‡è·‘ / å®‰å…¨ç§»å‹• / å¯å›æ»¾ï¼‰

## 0. å°ˆæ¡ˆç›®æ¨™
åœ¨ Windows ä¸Šæä¾›ä¸€å€‹ GUI å·¥å…·ï¼Œä½¿ç”¨è€…é¸æ“‡è³‡æ–™å¤¾å¾Œï¼š
1) éš”é›¢ç¸®åœ–ï¼ˆå°æª”æ¡ˆã€ä½è§£æï¼‰
2) å»é™¤é‡è¤‡ï¼ˆç²¾ç¢º hash + è¦–è¦ºç›¸ä¼¼ pHashï¼‰ï¼ŒåŒåœ–åªä¿ç•™æœ€å¤§è§£æåº¦
3) **ä¸æä¾›åˆªé™¤åŠŸèƒ½**ï¼šæ·˜æ±°æª”ä¸€å¾‹ç§»åˆ° `TO_DELETE/`
4) å¯é¸ï¼šä¾ Synology Photos é¢¨æ ¼é‡æ–°å‘½å `IMG_yyyyMMdd_HHmmss(_####)`ï¼ˆå››ä½æ•¸ suffixï¼‰
5) å¯é¸ï¼šä¾å¹´ä»½æˆ–æœˆä»½æ­¸æª”åˆ°å­è³‡æ–™å¤¾
6) æ¯æ¬¡åŸ·è¡Œç”¢ç”Ÿ `REPORT/manifest.jsonl` ä»¥æ”¯æ´å®Œæ•´å›æ»¾ï¼ˆUndoï¼‰
7) åŒä¸€è³‡æ–™å¤¾å¯é‡è·‘å¤šæ¬¡ï¼šè‹¥ç„¡ä»»ä½•ç¬¦åˆæ¢ä»¶çš„æª”æ¡ˆï¼Œåƒ…è¼¸å‡ºã€Œæª¢æŸ¥å ±å‘Šã€ï¼ˆNo changes neededï¼‰

---

## 1. ä¸å¯å¦¥å”ï¼ˆNon-negotiablesï¼‰
- **ä¸åˆªæª”**ï¼šç¨‹å¼ä¸å‘¼å« delete/unlink/rmtreeã€‚æ·˜æ±°æª”å…¨éƒ¨ç§»åˆ° `TO_DELETE/`
- **è·¨ç£ç¢Ÿå®‰å…¨**ï¼šè·¨ç£ç¢Ÿæ™‚æ”¹ç”¨ copy æ¨¡å¼ï¼Œä¾†æºæª”ä¿ç•™ä¸å‹•ï¼ˆè¦‹ Â§2.1ï¼‰
- **Dry-run**ï¼šå¿…é ˆå¯å…ˆé æƒæï¼ˆä¸å‹•æª”ï¼‰ï¼Œç”¢å‡ºè¡Œå‹•è¨ˆç•«èˆ‡çµ±è¨ˆ
- **å¯å›æ»¾**ï¼šæ¯æ¬¡åŸ·è¡Œå¿…é ˆå¯«å‡º `REPORT/manifest.jsonl`ï¼ˆå¯é€†æ“ä½œï¼‰
- **æµç¨‹é †åºå›ºå®š**ï¼šscan â†’ thumbnails â†’ exact dedupe â†’ near dedupe â†’ decide keepers â†’ move/copy â†’ (optional rename) â†’ (optional archive) â†’ reports
- **å¯é‡è·‘ï¼ˆå†ªç­‰ï¼‰**ï¼šé‡è·‘åŒä¸€è³‡æ–™å¤¾æ™‚ï¼Œè‹¥æ²’æœ‰ä»»ä½• actionï¼Œç¨‹å¼åªç”¢ç”Ÿå ±å‘Šä¸å‹•æª”
- **ä¸­æ–·å¯æ¢å¾©**ï¼šç¨‹å¼ä¸­é€”ä¸­æ–·æ™‚ï¼Œå·²å®Œæˆæ“ä½œè¨˜éŒ„åœ¨ manifest ä¸­ï¼Œå¯é¸æ“‡ç¹¼çºŒæˆ–å›æ»¾

---

## 2. æ¬Šé™èˆ‡è¡Œç‚ºæ‰¿è«¾ï¼ˆç¬¦åˆä½ çš„éœ€æ±‚ï¼‰
- æœ¬å·¥å…·åªåšä¸‰é¡è¡Œç‚ºï¼š
  1) è®€å–æª”æ¡ˆï¼ˆè®€å– metadata / EXIF / è§£æåº¦ï¼‰
  2) é‡æ–°å‘½åæª”æ¡ˆï¼ˆå¯é¸ï¼Œåƒ…å° KEEP ç”Ÿæ•ˆï¼‰
  3) æ¬ç§»æª”æ¡ˆï¼ˆåŒç£ç¢Ÿ moveï¼›è·¨ç£ç¢Ÿ copyï¼‰

### 2.1 è·¨ç£ç¢Ÿè™•ç†ç­–ç•¥ï¼ˆCriticalï¼‰
**å•é¡Œ**ï¼šPython `shutil.move()` è·¨ç£ç¢Ÿæ™‚åº•å±¤æœƒåŸ·è¡Œ copy + deleteï¼Œé•åã€Œä¸åˆªé™¤ã€æ‰¿è«¾ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼šå¼·åˆ¶ copy æ¨¡å¼
- ç¨‹å¼å•Ÿå‹•æ™‚æª¢æ¸¬ä¾†æºèˆ‡è¼¸å‡ºç›®éŒ„æ˜¯å¦åŒç£ç¢Ÿï¼ˆæ¯”å° drive letterï¼‰
- **åŒç£ç¢Ÿ**ï¼šä½¿ç”¨ `shutil.move()`ï¼ˆåŸå­æ“ä½œï¼‰
- **è·¨ç£ç¢Ÿ**ï¼šä½¿ç”¨ `shutil.copy2()`ï¼ˆä¿ç•™ metadataï¼‰
  - ä¾†æºæª”æ¡ˆä¿ç•™ä¸å‹•
  - ç›®æ¨™è·¯å¾‘å¯«å…¥ `KEEP/` æˆ– `TO_DELETE/`
  - manifest ä¸­æ¨™è¨˜ `"cross_drive": true`
  - GUI é¡¯ç¤ºè­¦å‘Šï¼šã€Œè·¨ç£ç¢Ÿæ“ä½œï¼Œä¾†æºæª”æ¡ˆå°‡ä¿ç•™ï¼Œéœ€æ‰‹å‹•æª¢æŸ¥å¾Œåˆªé™¤ã€
  
**ç©ºé–“éœ€æ±‚æ–‡ä»¶åŒ–**ï¼š
- åŒç£ç¢Ÿï¼šç„¡é¡å¤–ç©ºé–“éœ€æ±‚
- è·¨ç£ç¢Ÿï¼šéœ€è¦èˆ‡ä¾†æºæª”æ¡ˆç¸½å’Œç›¸åŒçš„ç›®æ¨™ç£ç¢Ÿç©ºé–“

**é€²éšé¸é …ï¼ˆv2.0ï¼‰**ï¼š
- æä¾›ã€Œè·¨ç£ç¢Ÿå¾Œè‡ªå‹•æ¸…å–®ã€åŠŸèƒ½ï¼šdry-run æª¢æŸ¥ç©ºé–“å……è¶³å¾Œæ‰åŸ·è¡Œ

### 2.2 ä¸è¨­è¨ˆä»»ä½•åˆªé™¤æµç¨‹
- æœ¬å·¥å…·**ä¸è¨­è¨ˆä»»ä½•åˆªé™¤æµç¨‹**ï¼Œä¸æä¾› UI/CLI åˆªé™¤æŒ‰éˆ•
- ä½¿ç”¨è€…éœ€æ‰‹å‹•æª¢æŸ¥ `TO_DELETE/` å¾Œï¼Œè‡ªè¡Œæ±ºå®šåˆªé™¤æ™‚æ©Ÿ

---

## 3. å››å€‹é—œéµæ±ºç­–ï¼ˆHash / HEIC / è·¨ç£ç¢Ÿæ™‚é–“ / pHashï¼‰
### Q1ï¼šExact duplicate hash
- **é è¨­ï¼šMD5**ï¼ˆç…§ç‰‡å»é‡æƒ…å¢ƒé€Ÿåº¦å¿«ä¸”è¶³å¤ æº–ç¢ºï¼‰
- å¯é¸ï¼šSHA-256ï¼ˆè‹¥åå¥½è¼ƒå¼·é›œæ¹Šï¼Œé€šå¸¸è¼ƒæ…¢ï¼‰
- å¿…åšæ•ˆèƒ½ï¼šä¸å¾—å°å…¨æª”ç®— hashï¼›å…ˆç”¨æª”æ¡ˆå¤§å°åˆ†æ¡¶ï¼Œå†å°å€™é¸ç¾¤ç®— hash
- ä»‹é¢/è¨­å®šï¼šæä¾› `hash_algo = md5 | sha256`ï¼ˆé è¨­ md5ï¼‰

### Q2ï¼šHEIC
- é è¨­ï¼šæ”¯æ´ï¼ˆpillow-heif/libheifï¼‰
- è‹¥ç„¡æ³•è§£ç¢¼ï¼š
  - è¨˜éŒ„ `UNSUPPORTED_HEIC`ï¼ˆreport + logï¼‰
  - ä¸ä¸­æ­¢æµç¨‹
  - ä»å¯åƒèˆ‡ exact dedupeï¼ˆsize â†’ hashï¼‰
  - è·³é near dedupeï¼ˆpHashï¼‰
  - thumbnail åˆ¤å®šï¼šæ‹¿ä¸åˆ° width/height å°±ä¸åˆ¤å®šï¼ˆé¿å…èª¤åˆ¤ï¼‰
- **Windows æ‰“åŒ…æ³¨æ„äº‹é …**ï¼š
  - æ¸¬è©¦ PyInstaller æ‰“åŒ…å¾Œ libheif DLL å¯ç”¨æ€§
  - è‹¥ libheif ä¸å¯ç”¨ï¼Œè·³é HEIC è§£æä½†ä¸ä¸­æ­¢
  - æ–‡ä»¶åŒ–ï¼šæ¨è–¦å®‰è£ã€ŒHEIF Image Extensionsã€ï¼ˆMicrosoft Storeï¼‰

### Q3ï¼šè·¨ç£ç¢Ÿ creation time è®Šæ›´
- å¯æ¥å—ä¸¦æ–‡ä»¶åŒ–
- rename/archive å¿…é ˆä½¿ç”¨ scan éšæ®µé–å®šçš„ `timestamp_locked`
- `shutil.copy2()` å¯ä¿ç•™ atime/mtimeï¼›Windows creation time ç„¡æ³•ä»¥æ¨™æº–æ–¹å¼ä¿ç•™ï¼ˆå±¬ç³»çµ±é™åˆ¶ï¼‰

### Q4ï¼špHash è·é›¢é–€æª»èˆ‡æ€§èƒ½
- é è¨­ï¼š8
- å¿…é ˆå¯èª¿ï¼ˆGUI + configï¼‰ï¼Œå»ºè­°ç¯„åœ 0â€“16
- dry-run å¿…é ˆé¡¯ç¤º near-duplicate ç¾¤çµ„æ‘˜è¦ä»¥åˆ©æŠ½æŸ¥
- **æ€§èƒ½å„ªåŒ–ç­–ç•¥**ï¼ˆCriticalï¼‰ï¼š
  1. **åªå°é€šé exact dedupe çš„æª”æ¡ˆè¨ˆç®— pHash**ï¼ˆé¿å…é‡è¤‡è¨ˆç®—ï¼‰
  2. **ä½¿ç”¨åˆ†æ¡¶ç´¢å¼•ï¼ˆMulti-key Bucketingï¼‰**ï¼š
     - **ç­–ç•¥**ï¼šå°‡ 64-bit pHash åˆ‡åˆ†ç‚ºå¤šå€‹é‡ç–Šç‰‡æ®µï¼Œå»ºç«‹å¤šå€‹ç´¢å¼•
     - **é è¨­æ–¹æ¡ˆ**ï¼šåˆ‡ 4 æ®µï¼ˆæ¯æ®µ 16 bitsï¼‰ï¼š[0:16], [16:32], [32:48], [48:64]
     - **ç†è«–åŸºç¤**ï¼šæ¼¢æ˜è·é›¢ â‰¤ 8 çš„å…©å€‹ hashï¼Œè‡³å°‘æœ‰ä¸€å€‹ 16-bit ç‰‡æ®µçš„è·é›¢ â‰¤ 2ï¼ˆé´¿ç± åŸç†ï¼‰
     - **å€™é¸é›†åˆ**ï¼šå–æ‰€æœ‰æ¡¶çš„è¯é›†ï¼Œé¿å…æ¼æŠ“é‚Šç•Œæƒ…æ³
     - **POC éšæ®µé©—è­‰**ï¼šå¯¦é©— 2/4/8 æ®µåˆ‡åˆ†ï¼Œæ‰¾å‡º recall/precision/speed æœ€ä½³å¹³è¡¡é»
  3. **è¨­å®šä¸Šé™**ï¼š`max_images_for_near_dedupe = 5000`ï¼ˆå¯èª¿ï¼‰
     - è¶…éæ­¤æ•¸é‡æ™‚è·³é Phase 4 ä¸¦è­¦å‘Šä½¿ç”¨è€…
     - GUI é¡¯ç¤ºï¼šã€Œæª”æ¡ˆæ•¸éå¤šï¼ˆX å¼µï¼‰ï¼Œå»ºè­°å…ˆåŸ·è¡Œ exact dedupe å¾Œå†è™•ç†ã€
  4. **é€²åº¦é¡¯ç¤º**ï¼š
     - pHash è¨ˆç®—é€²åº¦ï¼ˆX/Y imagesï¼‰
     - é ä¼°å‰©é¤˜æ™‚é–“ï¼ˆåŸºæ–¼å‰ 100 å¼µå¹³å‡é€Ÿåº¦ï¼‰

---

## 4. æ™‚é–“æˆ³è¦æ ¼ï¼ˆä¿®æ­£ç‰ˆï¼‰
- EXIF DateTimeOriginal é€šå¸¸ä¸å«æ™‚å€
- `timestamp_locked` ä»¥ã€Œæœ¬åœ°æ™‚é–“å­—ä¸²ã€å„²å­˜ï¼Œä¸åŠ  Zï¼ˆé¿å…å‡è£ UTCï¼‰
  - æ ¼å¼ï¼š`YYYY-MM-DD HH:MM:SS`
- `timestamp_source`ï¼šexif | created_time | unknown
- **æ–°å¢æ™‚å€è³‡è¨Š**ï¼ˆç”¨æ–¼ rollback æ™‚åƒè€ƒï¼‰ï¼š
  - `scan_machine_timezone`ï¼šè¨˜éŒ„åŸ·è¡Œ scan æ™‚çš„ç³»çµ±æ™‚å€ï¼ˆä¾‹å¦‚ `UTC+8`ï¼‰
  - ç”¨é€”ï¼šè·¨æ™‚å€ rollback æ™‚æä¾›åƒè€ƒï¼Œé¿å…æ™‚é–“éŒ¯èª¤

---

## 5. åŸ·è¡Œæ¨¡å¼ï¼ˆæ”¯æ´é‡è·‘èˆ‡åªåšæ”¹åï¼‰
### Mode Aï¼šFull Runï¼ˆå®Œæ•´æ•´ç†ï¼‰
**ç¯„åœ**ï¼šä½¿ç”¨è€…é¸æ“‡çš„åŸå§‹è³‡æ–™å¤¾
**æµç¨‹**ï¼šscan â†’ thumbnails â†’ exact dedupe â†’ near dedupe â†’ decide keepers â†’ move/copy â†’ (optional rename) â†’ (optional archive) â†’ reports

### Mode Bï¼šRename-onlyï¼ˆåªæ”¹åï¼‰
**ç¯„åœ**ï¼šä½¿ç”¨è€…é¸æ“‡ä»»æ„è³‡æ–™å¤¾ï¼ˆå¯ä»¥æ˜¯åŸå§‹è³‡æ–™å¤¾æˆ–å·²åŸ·è¡Œéçš„ `KEEP/`ï¼‰
**è¡Œç‚º**ï¼š
- åªå°ç¾æœ‰æª”æ¡ˆåŸ·è¡Œ renameï¼ˆä¾ Synology æ ¼å¼ï¼‰
- å¯é¸ archiveï¼ˆä¾ year/monthï¼‰
- **è¼¸å‡ºé¸é …**ï¼š
  - åŸåœ°æ”¹åï¼ˆin-placeï¼‰
  - è¼¸å‡ºåˆ°æ–°è³‡æ–™å¤¾ï¼ˆé¡ä¼¼ Full Run çµæ§‹ï¼‰
**ç¦æ­¢**ï¼šthumbnail/dedupe/ç§»åˆ° TO_DELETE

**ä½¿ç”¨å ´æ™¯**ï¼š
1. å°åŸå§‹è³‡æ–™å¤¾åŸ·è¡Œï¼ˆä¸åš dedupeï¼Œåªæ”¹åï¼‰
2. å°å·²åŸ·è¡Œé Full Run çš„ KEEP/ è£œæ”¹å

### Mode Cï¼šArchive-onlyï¼ˆåªæ­¸æª”ï¼‰
**ç¯„åœ**ï¼šä½¿ç”¨è€…é¸æ“‡ä»»æ„è³‡æ–™å¤¾ï¼ˆé€šå¸¸æ˜¯ `KEEP/`ï¼‰
**è¡Œç‚º**ï¼šä¾ year/month æ¬ç§»åˆ°å­è³‡æ–™å¤¾
**ç¦æ­¢**ï¼šthumbnail/dedupe/rename

> GUI å¿…é ˆæä¾›æ¨¡å¼é¸æ“‡ä¸‹æ‹‰é¸å–®ï¼›é è¨­ Mode A ä¸¦è‡ªå‹•é–‹å•Ÿ dry-run é è¦½ã€‚

---

## 6. ç›®éŒ„çµæ§‹ï¼ˆè¼¸å‡ºï¼‰
æ¯æ¬¡åŸ·è¡Œå»ºç«‹è¼¸å‡ºæ ¹ç›®éŒ„ï¼ˆä¾‹å¦‚ `Processed_YYYYMMDD_HHMMSS/`ï¼‰ï¼š
- `KEEP/`
- `TO_DELETE/`
  - `THUMBNAILS/`
  - `DUPLICATES_EXACT/`
  - `DUPLICATES_SIMILAR/`
- `REPORT/`
  - `manifest.jsonl`ï¼ˆæ¯è¡Œä¸€å€‹ JSON ç‰©ä»¶ï¼Œæ”¯æ´ä¸²æµå¯«å…¥ï¼‰
  - `report.csv`
  - `summary.txt`
  - `error.log`

### 6.1 è¼¸å‡ºæ ¹ç›®éŒ„é è¨­ä½ç½®
- **é è¨­**ï¼šåœ¨ä¾†æºè³‡æ–™å¤¾å…§éƒ¨å»ºç«‹ï¼Œä¾‹å¦‚ä½¿ç”¨è€…é¸æ“‡ `D:\Photos`ï¼Œè¼¸å‡ºç‚º `D:\Photos\Processed_YYYYMMDD_HHMMSS/`
- **å¯è‡ªè¨‚**ï¼šä½¿ç”¨è€…å¯åœ¨ GUI ä¸­æ‰‹å‹•æŒ‡å®šè¼¸å‡ºè·¯å¾‘ï¼ˆå¯é¸ä¸åŒç£ç¢Ÿï¼‰
- **è·¨ç£ç¢Ÿåˆ¤æ–·**ï¼šæ¯”å°ä¾†æºè³‡æ–™å¤¾èˆ‡å¯¦éš›è¼¸å‡ºæ ¹ç›®éŒ„çš„ drive letterï¼ˆè€Œéé è¨­å€¼ï¼‰

---

## 7. Pipelineï¼ˆè³‡æ–™æµç¨‹èˆ‡æª¢æŸ¥é»ï¼‰
### Phase 1 â€” Scanï¼ˆåƒ… metadataï¼‰
æ”¶é›†ï¼š
- pathã€size_bytesã€extã€drive_letterï¼ˆç”¨æ–¼è·¨ç£ç¢Ÿæª¢æ¸¬ï¼‰
- resolutionï¼ˆè‹¥å¯è®€ï¼‰
- exif_datetime_originalï¼ˆè‹¥å¯è®€ï¼‰
- windows_created_timeï¼ˆst_ctimeï¼ŒWindows-only fallbackï¼‰
- è¨ˆç®—ä¸¦é–å®š `timestamp_locked`ï¼ˆexif â†’ created_time â†’ unknownï¼‰
- è¨˜éŒ„ `scan_machine_timezone`ï¼ˆç³»çµ±æ™‚å€ï¼‰

æ­¤éšæ®µç¦æ­¢ï¼š
- å…¨æª” hash
- å…¨æª” pHash

**Scan æ’é™¤è¦å‰‡ï¼ˆé‡è·‘å®‰å…¨ï¼‰**ï¼š
- è‡ªå‹•æ’é™¤ä»¥ä¸‹å­ç›®éŒ„ï¼Œé¿å…é‡è·‘æ™‚æƒæåˆ°ä¸Šæ¬¡è¼¸å‡ºï¼š
  - åç¨±åŒ¹é… `Processed_*` çš„è³‡æ–™å¤¾
  - `TO_DELETE/`ã€`KEEP/`ã€`REPORT/` ç›®éŒ„
  - `ROLLBACK_CONFLICTS/`ã€`ROLLBACK_TRASH/` ç›®éŒ„
- ç¬¦è™Ÿé€£çµï¼ˆsymlink / junctionï¼‰ï¼š**è·³éä¸æƒæ**ï¼Œè¨˜éŒ„ `SKIPPED_SYMLINK` åˆ° logï¼Œé¿å…é‡è¤‡è¨ˆç®—æˆ–éè¿´

**è·¨ç£ç¢Ÿæª¢æ¸¬**ï¼š
- æ¯”å°ä¾†æºè³‡æ–™å¤¾èˆ‡è¼¸å‡ºç›®éŒ„çš„ drive letter
- è‹¥è·¨ç£ç¢Ÿï¼ŒGUI é¡¯ç¤ºè­¦å‘Šä¸¦åˆ‡æ›ç‚º copy æ¨¡å¼

### Phase 2 â€” Thumbnail isolation
**æ˜ç¢ºè¦å‰‡**ï¼ˆå¯èª¿ï¼‰ï¼š
```python
is_thumbnail = (
    (size_bytes <= 120_000 AND max(width, height) <= 640)  # A: å°æª”+ä½è§£æ
    OR
    (max(width, height) <= 320)  # B: æ¥µå°åœ–ä¸€å®šæ˜¯ç¸®åœ–
)
```
å‘½ä¸­è€…ï¼šreason=THUMBNAIL â†’ ç§»åˆ° `TO_DELETE/THUMBNAILS/`

**è‹¥ç„¡æ³•è®€å– width/height**ï¼ˆä¾‹å¦‚ HEIC è§£ç¢¼å¤±æ•—ï¼‰ï¼š
- ä¸å¥—ç”¨è¦å‰‡ A å’Œ B
- è¨˜éŒ„ `CANNOT_DETERMINE_RESOLUTION`
- ç¹¼çºŒå¾ŒçºŒæµç¨‹ï¼ˆå¯åƒèˆ‡ exact dedupeï¼‰

### Phase 3 â€” Exact dedupeï¼ˆHashï¼‰
- å…ˆ size åˆ†æ¡¶
- bucket å…§å€™é¸æ•¸ â‰¥ 2 ä¸”éç¸®åœ–è€…æ‰ç®— hashï¼ˆé è¨­ MD5ï¼Œå¯é¸ SHA-256ï¼‰
- åŒ hash è¦–ç‚ºå®Œå…¨é‡è¤‡ï¼ˆbit-for-bit ç›¸åŒï¼‰

ä¿ç•™ç­–ç•¥ï¼ˆåŒ hash ç¾¤çµ„åªç•™ 1ï¼‰ï¼š
> è¨»ï¼šåŒ hash ä»£è¡¨æª”æ¡ˆå…§å®¹å®Œå…¨ç›¸åŒï¼Œå› æ­¤è§£æåº¦/æª”æ¡ˆå¤§å°é€šå¸¸ä¹Ÿç›¸åŒï¼Œtiebreaker éœ€æ¡ç”¨ã€Œè·¯å¾‘/å‘½åã€ç­‰ç©©å®šè¦å‰‡ã€‚
1) è·¯å¾‘æ·±åº¦è¼ƒæ·ºï¼ˆè¼ƒæ¥è¿‘æ ¹ç›®éŒ„è€…å„ªå…ˆï¼‰
2) æª”åç©©å®šæ’åºï¼ˆå­—å…¸åºè¼ƒå°è€…å„ªå…ˆï¼‰
3) ä»ç›¸åŒå‰‡ä»¥å®Œæ•´è·¯å¾‘å­—å…¸åºæœ€å°è€…ç‚º keeperï¼ˆç¢ºä¿é‡è·‘çµæœä¸€è‡´ï¼‰

æ·˜æ±°è€… â†’ `TO_DELETE/DUPLICATES_EXACT/`

### Phase 4 â€” Near dedupeï¼ˆpHashï¼Œé«˜æ•ˆç´¢å¼•ï¼‰
**å‰ç½®æª¢æŸ¥**ï¼š
- è‹¥æª”æ¡ˆæ•¸ > `max_images_for_near_dedupe`ï¼ˆé è¨­ 5000ï¼‰ï¼š
  - è·³éæ­¤ phase
  - åœ¨ summary.txt ä¸­è­¦å‘Šï¼šã€Œæª”æ¡ˆæ•¸éå¤šï¼Œå·²è·³éè¦–è¦ºç›¸ä¼¼æ¯”å°ã€
  - ä½¿ç”¨è€…å¯é¸æ“‡ï¼šå…ˆåŸ·è¡Œ exact dedupeï¼Œå†å° KEEP/ åŸ·è¡Œç¬¬äºŒè¼ª Full Run æˆ–æ”¹ç”¨ Rename-only/Archive-only

**åŸ·è¡Œæµç¨‹**ï¼š
1) **åªå°é€šé exact dedupe çš„å½±åƒæª”è¨ˆç®— pHash**
2) **ç”¢ç”Ÿ pHash**ï¼ˆ64-bitï¼‰
3) **å¤šéµåˆ†æ¡¶ï¼ˆmulti-key bucketingï¼‰**ï¼šä»¥ pHash ä¸åŒç‰‡æ®µå»ºç«‹å¤šå€‹ bucket keyï¼ˆä¾‹å¦‚åˆ‡ 4 æ®µï¼š0â€“15ã€16â€“31ã€32â€“47ã€48â€“63ï¼‰
4) **å€™é¸é›†åˆ**ï¼šå–å¤šå€‹æ¡¶çš„è¯é›†ä½œç‚ºå€™é¸ï¼Œé¿å…ã€Œåªæ¯”åŒæ¡¶ã€é€ æˆæ¼æŠ“
5) **è·é›¢è¨ˆç®—**ï¼šåªåœ¨å€™é¸é›†åˆå…§è¨ˆç®— Hamming distance
6) **threshold é è¨­ 8**ï¼ˆå¯èª¿ï¼‰
7) **ç¾¤çµ„å½¢æˆ**ï¼šä½¿ç”¨ union-findï¼ˆé€£é€šåˆ†é‡ï¼‰å°‡è·é›¢ â‰¤ threshold çš„ pair åˆä½µæˆç¾¤çµ„
8) **GUI é€²åº¦é¡¯ç¤º**ï¼š
   - ã€Œæ­£åœ¨è¨ˆç®—è¦–è¦ºæŒ‡ç´‹... (X/Y)ã€
   - æ¯ 100 å¼µæ›´æ–°ä¸€æ¬¡ä¼°ç®—

**ä¿ç•™ç­–ç•¥ï¼ˆnear-duplicate ç¾¤çµ„ï¼Œèˆ‡ Phase 3 ä¸åŒï¼‰**ï¼š
> è¨»ï¼šnear-duplicate ç¾¤çµ„å…§çš„æª”æ¡ˆå…§å®¹ä¸åŒï¼ˆåƒ…è¦–è¦ºç›¸ä¼¼ï¼‰ï¼Œå› æ­¤å¿…é ˆå„ªå…ˆä¿ç•™å“è³ªæœ€ä½³è€…ã€‚
1) `max(width, height)` æœ€å¤§è€…ï¼ˆæœ€é«˜è§£æåº¦ï¼‰
2) `size_bytes` æœ€å¤§è€…ï¼ˆæœ€å¤§æª”æ¡ˆ = æœ€å°‘å£“ç¸®æå¤±ï¼‰
3) è·¯å¾‘æ·±åº¦è¼ƒæ·ºï¼ˆè¼ƒæ¥è¿‘æ ¹ç›®éŒ„è€…å„ªå…ˆï¼‰
4) å®Œæ•´è·¯å¾‘å­—å…¸åºæœ€å°ï¼ˆç¢ºä¿é‡è·‘çµæœä¸€è‡´ï¼‰

æ·˜æ±°è€… â†’ `TO_DELETE/DUPLICATES_SIMILAR/`

### Phase 5 â€” Action Planï¼ˆå¯é‡è·‘æ ¸å¿ƒï¼‰
- dry-run æ™‚ç”¢ç”Ÿ action planï¼ˆæ¯ç­†åŒ…å«å‹•ä½œèˆ‡ç†ç”±ï¼‰
- è‹¥ action plan ç‚ºç©ºï¼š
  - é¡¯ç¤ºã€ŒNo changes neededã€
  - ä»ç”¢å‡º `summary.txt`ï¼ˆå¯é¸ç”¢å‡º report.csvï¼‰
  - ä¸åŸ·è¡Œä»»ä½• move/rename

### Phase 6 â€” Executeï¼ˆå¯¦éš›æ¬ç§»/è¤‡è£½/æ”¹åï¼Œæ”¯æ´ä¸­æ–·æ¢å¾©ï¼‰
**ä¸²æµå¯«å…¥ manifest**ï¼š
- ä½¿ç”¨ JSONL æ ¼å¼ï¼ˆæ¯è¡Œä¸€å€‹ JSON ç‰©ä»¶ï¼‰
- æ¯å®Œæˆä¸€ç­†æ“ä½œç«‹å³ append åˆ° `manifest.jsonl`
- é¿å…ç¨‹å¼ä¸­æ–·å°è‡´ manifest ä¸å®Œæ•´

**åŸ·è¡Œå‰æª¢æŸ¥**ï¼š
- æª¢æŸ¥æ˜¯å¦å­˜åœ¨æœªå®Œæˆçš„ `manifest.jsonl.partial`
- è‹¥å­˜åœ¨ï¼Œè©¢å•ä½¿ç”¨è€…ï¼š
  1. **ç¹¼çºŒåŸ·è¡Œ**ï¼ˆresumeï¼‰ï¼šè·³éå·²å®Œæˆçš„æ“ä½œ
  2. **å›æ»¾å·²åŸ·è¡Œéƒ¨åˆ†**ï¼šåå‘åŸ·è¡Œ manifest ä¸­çš„æ“ä½œ
  3. **æ”¾æ£„**ï¼šä¿ç•™ç¾ç‹€ï¼Œåˆªé™¤ partial æª”æ¡ˆ

**åŸ·è¡Œé‚è¼¯**ï¼š
- åŒç£ç¢Ÿï¼š`shutil.move()`
- è·¨ç£ç¢Ÿï¼š`shutil.copy2()`ï¼ˆä¾†æºä¿ç•™ï¼‰
- æ‰€æœ‰å‹•ä½œé€ç­†å¯«å…¥ manifestï¼ˆsuccess/failedï¼‰
- å¤±æ•—ä¸å½±éŸ¿å…¶ä»–æª”æ¡ˆç¹¼çºŒè™•ç†ï¼ˆè¨˜éŒ„ error.logï¼‰

**å®Œæˆå¾Œ**ï¼š
- å°‡ `manifest.jsonl.partial` é‡å‘½åç‚º `manifest.jsonl`

### Phase 7 â€” Optional renameï¼ˆGUI checkboxï¼Œé è¨­ OFFï¼‰
- åªå° KEEP æª”æ¡ˆç”Ÿæ•ˆ
- æ ¼å¼ï¼š`IMG_yyyyMMdd_HHmmss`ï¼Œæ’ååŠ  `_0001` `_0002`ï¼ˆå››ä½æ•¸ï¼Œæ”¯æ´æœ€å¤š 9999 å¼µï¼‰
- æ™‚é–“ä¾†æºç”¨ `timestamp_locked`ï¼Œä¸å¾—ç”¨æ¬ç§»å¾Œ creation time

### Phase 8 â€” Optional archiveï¼ˆGUI checkboxï¼Œé è¨­ OFFï¼‰
- yearï¼š`KEEP/2024/`
- monthï¼š`KEEP/2024-07/`
- ä½¿ç”¨ `timestamp_locked`

---

## 8. manifest.jsonlï¼ˆå›æ»¾é—œéµï¼Œå¿…é ˆå¯é€†ï¼‰
**æ ¼å¼**ï¼šJSONLï¼ˆæ¯è¡Œä¸€å€‹ JSON ç‰©ä»¶ï¼‰

æ¯ç­†è‡³å°‘åŒ…å«ï¼š
```json
{
  "id": "uuid-v4",
  "action": "MOVE | COPY | RENAME",
  "reason": "THUMBNAIL | DUP_EXACT | DUP_SIMILAR | KEPT_BEST | ARCHIVE",
  "src_path": "C:\\Source\\IMG_001.jpg",
  "dst_path": "C:\\Output\\TO_DELETE\\THUMBNAILS\\IMG_001.jpg",
  "timestamp_locked": "2024-07-15 14:30:00",
  "timestamp_source": "exif",
  "scan_machine_timezone": "UTC+8",
  "size_bytes": 102400,
  "file_hash": "d41d8cd98f00b204e9800998ecf8427e",
  "hash_algo": "md5",
  "phash": "fedcba9876543210",
  "cross_drive": false,
  "status": "success | failed",
  "error": "éŒ¯èª¤è¨Šæ¯ï¼ˆè‹¥å¤±æ•—ï¼‰"
}
```

**å›æ»¾ï¼ˆRollbackï¼‰**ï¼š
- ä¾ manifest é€†åºé€ç­†åŸ·è¡Œåå‘æ“ä½œ
- `MOVE` â†’ move back
- `COPY` â†’ **ä¸åˆªé™¤** dstï¼›å°‡ dst æ¬ç§»åˆ° `ROLLBACK_TRASH/`ï¼ˆæˆ– `TO_DELETE/ROLLBACK/`ï¼‰ä¸¦è¨˜éŒ„
- `RENAME` â†’ rename back
- ç›®çš„åœ°è¡çª â†’ ç§»åˆ° `ROLLBACK_CONFLICTS/` ä¸¦è¨˜éŒ„
- ç”¢ç”Ÿ `rollback_report.txt`

---

## 9. GUI éœ€æ±‚ï¼ˆæ–°å¢ï¼šå¯é‡è·‘èˆ‡ no-opï¼‰
å¿…é ˆåŒ…å«ï¼š
- **ä¾†æºè³‡æ–™å¤¾**ï¼šé¸æ“‡å™¨
- **è¼¸å‡ºæ ¹ç›®éŒ„**ï¼šé è¨­ `Processed_YYYYMMDD_HHMMSS`ï¼ˆåœ¨ä¾†æºè³‡æ–™å¤¾å…§ï¼‰ï¼Œå¯è‡ªè¨‚ç‚ºä»»æ„è·¯å¾‘
- **æ¨¡å¼é¸æ“‡**ï¼šä¸‹æ‹‰é¸å–®ï¼ˆFull Run / Rename-only / Archive-onlyï¼‰
- **æŒ‰éˆ•**ï¼š
  - **Dry-run Scan**ï¼šç”¢ç”Ÿ action plan èˆ‡çµ±è¨ˆï¼Œä¸å‹•æª”
  - **Execute**ï¼šä¾ action plan åŸ·è¡Œï¼ˆåƒ… dry-run å®Œæˆå¾Œå•Ÿç”¨ï¼‰
  - **Rollback Last Run**ï¼šè®€å– manifest.jsonl ä¸¦åå‘åŸ·è¡Œ
- **é¸é …**ï¼ˆCheckboxesï¼‰ï¼š
  - â˜ Enable Renamingï¼ˆé è¨­ OFFï¼‰
  - â˜ Enable Archivingï¼ˆé è¨­ OFFï¼‰
    - Archive modeï¼šâ—‰ Year â—‹ Month
- **é€²éšè¨­å®š**ï¼ˆå¯æ‘ºç–Šå€åŸŸï¼‰ï¼š
  - pHash thresholdï¼ˆæ»‘æ¡¿ 0â€“16ï¼Œé è¨­ 8ï¼‰
  - Max images for near-dedupeï¼ˆé è¨­ 5000ï¼‰
  - Thumbnail rulesï¼ˆæª”æ¡ˆå¤§å° KB / é‚Šé•· pxï¼‰
- **é€²åº¦é¡¯ç¤º**ï¼š
  - é€²åº¦æ¢
  - ç•¶å‰éšæ®µï¼ˆScanning / Calculating pHash / Moving files...ï¼‰
  - ç°¡æ˜“ log å€ï¼ˆæœ€è¿‘ 20 æ¢ï¼‰
- **è­¦å‘Šæç¤º**ï¼š
  - è·¨ç£ç¢Ÿæ™‚é¡¯ç¤ºï¼šã€Œâš ï¸ è·¨ç£ç¢Ÿæ“ä½œï¼Œä¾†æºæª”æ¡ˆå°‡ä¿ç•™ï¼Œè«‹æ‰‹å‹•æª¢æŸ¥å¾Œåˆªé™¤ã€

### 9.1 GUI åŸ·è¡Œç·’æ¶æ§‹ï¼ˆCriticalï¼‰
- æ‰€æœ‰ pipeline æ“ä½œï¼ˆscan / hash / pHash / moveï¼‰å¿…é ˆåœ¨**èƒŒæ™¯åŸ·è¡Œç·’**ä¸­åŸ·è¡Œ
- GUI ä¸»åŸ·è¡Œç·’é€é `queue.Queue` æ¥æ”¶é€²åº¦æ›´æ–°ï¼Œé¿å… UI å‡çµ
- èƒŒæ™¯åŸ·è¡Œç·’é€é callback å ±å‘Šï¼šéšæ®µåç¨±ã€é€²åº¦ç™¾åˆ†æ¯”ã€ç•¶å‰æª”æ¡ˆåã€éŒ¯èª¤è¨Šæ¯
- **å–æ¶ˆæ”¯æ´**ï¼šä½¿ç”¨è€…å¯éš¨æ™‚æŒ‰ã€ŒCancelã€ä¸­æ–·èƒŒæ™¯åŸ·è¡Œç·’ï¼ˆé€é threading.Event flagï¼‰

---

## 10. æ¸¬è©¦è¨ˆç•«ï¼ˆè‡³å°‘ 25 çµ„ï¼‰
### åŸºç¤åŠŸèƒ½ï¼ˆ1-7ï¼‰
1) åŸåœ– + 320px ç¸®åœ– â†’ åŸåœ– KEEPã€ç¸®åœ– TO_DELETE/THUMBNAILS
2) åŒåœ–ä¸åŒè§£æåº¦ â†’ æœ€å¤§è§£æåº¦ KEEP
3) åŒå…§å®¹å®Œå…¨ç›¸åŒï¼ˆhash ç›¸åŒï¼‰â†’ åªç•™ 1
4) è¿‘ä¼¼ç›¸åŒï¼ˆä¸åŒå£“ç¸®ï¼‰â†’ pHash ç¾¤çµ„åªç•™æœ€å¤§è§£æåº¦
5) åŒç§’é€£æ‹ rename â†’ _0001~ ä¸æ’å
6) ç„¡ EXIF â†’ ç”¨ created_time å‘½åèˆ‡æ­¸æª”
7) HEIC å¯è§£ç¢¼ â†’ åƒèˆ‡ pHash

### HEIC èˆ‡éŒ¯èª¤è™•ç†ï¼ˆ8-10ï¼‰
8) HEIC ä¸å¯è§£ç¢¼ â†’ è·³é pHashã€ä¸å´©æ½°ã€ä»å¯ exact dedupe
9) æ¬Šé™ä¸è¶³æª”æ¡ˆ â†’ å–®ç­† failedï¼Œå…¶ä»–ç¹¼çºŒ
10) å”¯è®€æª”æ¡ˆ â†’ è¨˜éŒ„ failed ä¸”ä¸ä¸­æ­¢

### å¯é‡è·‘èˆ‡æ¨¡å¼ï¼ˆ11-13ï¼‰
11) é‡è·‘åŒè³‡æ–™å¤¾ä¸”ç„¡æ–°è®Šæ›´ â†’ action plan ç©ºï¼Œé¡¯ç¤º No changes needed
12) Rename-only æ¨¡å¼ï¼šç¬¬ä¸€æ¬¡ä¸æ”¹åï¼Œç¬¬äºŒæ¬¡åªæ”¹åï¼Œä¸ç§»å‹•åˆ° TO_DELETE
13) Archive-only æ¨¡å¼ï¼šåªå»ºç«‹ year/month å­è³‡æ–™å¤¾ï¼Œä¸åš dedupe

### è·¨ç£ç¢Ÿèˆ‡å›æ»¾ï¼ˆ14-16ï¼‰
14) è·¨ç£ç¢Ÿæ“ä½œ â†’ ä½¿ç”¨ copy æ¨¡å¼ï¼Œä¾†æºä¿ç•™ï¼Œmanifest æ¨™è¨˜ cross_drive=true
15) Rollback â†’ é‚„åŸè·¯å¾‘æˆ–è¡çªè³‡æ–™å¤¾ï¼Œreport æ¸…æ¥š
16) åŸ·è¡Œä¸­é€”ä¸­æ–·ï¼ˆCtrl+Cï¼‰â†’ é‡å•Ÿå¾Œå¯é¸æ“‡ç¹¼çºŒ/å›æ»¾/æ”¾æ£„

### é‚Šç•Œæ¢ä»¶ï¼ˆ17-20ï¼‰
17) ç©ºè³‡æ–™å¤¾ â†’ é¡¯ç¤º "No files found"
18) å…¨éƒ¨æ˜¯ç¸®åœ– â†’ KEEP/ ç‚ºç©ºï¼Œsummary èªªæ˜
19) æª”åå«ç‰¹æ®Šå­—å…ƒï¼ˆUnicodeã€emojiã€ç©ºæ ¼ï¼‰â†’ æ­£ç¢ºè™•ç†
20) è¶…é•·è·¯å¾‘ï¼ˆ>260 å­—å…ƒï¼‰â†’ éŒ¯èª¤è™•ç†ä¸¦è¨˜éŒ„

### æ€§èƒ½æ¸¬è©¦ï¼ˆ21-23ï¼‰
21) 10,000+ å¼µåœ–çš„æ€§èƒ½æ¸¬è©¦ â†’ åˆç†åŸ·è¡Œæ™‚é–“ï¼ˆexact dedupe < 10 åˆ†é˜ï¼‰
22) è¶…é 5000 å¼µåœ– â†’ è·³é pHash ä¸¦è­¦å‘Šä½¿ç”¨è€…
23) pHash è¨ˆç®—é€²åº¦é¡¯ç¤ºæ­£ç¢ºï¼Œé ä¼°æ™‚é–“åˆç†

### å›æ»¾é€²éšï¼ˆ24-25ï¼‰
24) manifest.jsonl éƒ¨åˆ†ææ¯€ â†’ rollback éŒ¯èª¤è™•ç†ï¼Œç”¢ç”Ÿæ¸…æ™°å ±å‘Š
25) å›æ»¾å¾Œç›®æ¨™è·¯å¾‘å·²è¢«ä½”ç”¨ â†’ ç§»åˆ° ROLLBACK_CONFLICTS/

---

## 11. æŠ€è¡“é©—è­‰ POCï¼ˆProof of Conceptï¼‰
åœ¨æ­£å¼é–‹ç™¼å‰ï¼Œå¿…é ˆé©—è­‰ä»¥ä¸‹æŠ€è¡“å¯è¡Œæ€§ï¼š

### POC-1ï¼špillow-heif åœ¨ Windows æ‰“åŒ…å¾Œå¯ç”¨æ€§
- **æ¸¬è©¦ç’°å¢ƒ**ï¼šPyInstaller æ‰“åŒ…ç‚º exe
- **æ¸¬è©¦é …ç›®**ï¼š
  - libheif DLL èƒ½å¦æ­£ç¢ºåµŒå…¥
  - èƒ½å¦è§£æ iPhone HEIC ç…§ç‰‡ï¼ˆæ¸¬è©¦ 3â€“5 å¼µçœŸå¯¦ iPhone ç…§ç‰‡ï¼‰
- **æˆåŠŸæ¨™æº–**ï¼š
  - âœ… æ‰“åŒ…å¾Œ exe å¯æˆåŠŸè§£æ HEIC ä¸¦å–å¾— width/height
  - âœ… æª”æ¡ˆå¤§å°å¢åŠ  < 10 MBï¼ˆDLL åµŒå…¥åˆç†ï¼‰
- **å¤±æ•—æ‡‰å°ï¼ˆPlan Bï¼‰**ï¼š
  - é™ç´šç‚ºã€Œåƒ…æ”¯æ´ JPG/PNG/GIF/BMPã€
  - HEIC æª”æ¡ˆæ¨™è¨˜ç‚º `UNSUPPORTED_FORMAT`ï¼Œå¯åƒèˆ‡ exact dedupe ä½†è·³é resolution åˆ¤å®š
  - æ–‡ä»¶ä¸­æ˜ç¢ºèªªæ˜ï¼šã€ŒHEIC æ”¯æ´éœ€æ‰‹å‹•å®‰è£ HEIF Image Extensionsï¼ˆMicrosoft Storeï¼‰ã€
- **é æœŸæ™‚é–“**ï¼š0.5 å¤©

### POC-2ï¼špHash åœ¨ 1000 å¼µåœ–ä¸Šçš„åŸ·è¡Œæ™‚é–“èˆ‡åˆ†æ¡¶ç­–ç•¥
- **æ¸¬è©¦ç’°å¢ƒ**ï¼šå…¸å‹ Windows 10 PCï¼ˆ4 æ ¸å¿ƒï¼Œ16GB RAMï¼‰
- **æ¸¬è©¦é …ç›®**ï¼š
  - è¨ˆç®— 1000 å¼µ 4000Ã—3000 JPEG çš„ pHash
  - **å¯¦é©— 3 ç¨®åˆ†æ¡¶ç­–ç•¥**ï¼š
    - æ–¹æ¡ˆ Aï¼š2 æ®µï¼ˆæ¯æ®µ 32 bitsï¼‰
    - æ–¹æ¡ˆ Bï¼š4 æ®µï¼ˆæ¯æ®µ 16 bitsï¼‰
    - æ–¹æ¡ˆ Cï¼š8 æ®µï¼ˆæ¯æ®µ 8 bitsï¼‰
  - ä½¿ç”¨åˆ†æ¡¶ç´¢å¼•å¾Œçš„æ¯”å°æ™‚é–“
  - æº–å‚™æ¸¬è©¦ç”¨åœ–é›†ï¼ˆå¯ç”¨ Unsplash æ‰¹æ¬¡ä¸‹è¼‰æˆ–è‡ªå»ºï¼‰
  - æ¸¬è©¦ recallï¼ˆæ˜¯å¦æ¼æŠ“ï¼‰èˆ‡ precisionï¼ˆæ˜¯å¦èª¤å ±ï¼‰
- **æˆåŠŸæ¨™æº–**ï¼š
  - âœ… ç¸½æ™‚é–“ < 5 åˆ†é˜ï¼ˆå«è¨ˆç®— pHash + åˆ†æ¡¶ + æ¯”å°ï¼‰
  - âœ… Recall â‰¥ 95%ï¼ˆèˆ‡æš´åŠ›æ¯”å°çµæœç›¸æ¯”ï¼‰
  - âœ… è¨˜æ†¶é«”ä½¿ç”¨ < 2 GB
- **å¤±æ•—æ‡‰å°ï¼ˆPlan Bï¼‰**ï¼š
  - é™ä½ `max_images_for_near_dedupe` è‡³ 2000
  - æä¾›ã€Œåˆ†æ‰¹è™•ç†æ¨¡å¼ã€ï¼šä½¿ç”¨è€…å¯æ‰‹å‹•å°‡å¤§è³‡æ–™å¤¾åˆ†æ‰¹åŸ·è¡Œ
  - è€ƒæ…®ä½¿ç”¨æ›´é«˜æ•ˆçš„ pHash å‡½å¼åº«ï¼ˆä¾‹å¦‚ï¼š`pypi/dhash` æ›¿ä»£ `imagehash`ï¼‰
- **é æœŸæ™‚é–“**ï¼š1.5â€“2 å¤©ï¼ˆå«æ¸¬è©¦åœ–é›†æº–å‚™èˆ‡åˆ†æ¡¶ç´¢å¼•å¯¦ä½œï¼‰

### POC-3ï¼šè·¨ç£ç¢Ÿ copy çš„æ­£ç¢ºæ€§
- **æ¸¬è©¦é …ç›®**ï¼š
  - `shutil.copy2()` æ˜¯å¦ä¿ç•™ mtime
  - manifest æ˜¯å¦æ­£ç¢ºæ¨™è¨˜ cross_drive
  - ä¾†æºæª”æ¡ˆç¢ºå¯¦ä¿ç•™ä¸å‹•
  - æ¸¬è©¦å¾ C: â†’ D: çš„è¤‡è£½è¡Œç‚º
- **æˆåŠŸæ¨™æº–**ï¼š
  - âœ… mtime æ­£ç¢ºä¿ç•™ï¼ˆèª¤å·® < 1 ç§’ï¼‰
  - âœ… manifest ä¸­ `cross_drive: true` æ­£ç¢ºæ¨™è¨˜
  - âœ… ä¾†æºæª”æ¡ˆå®Œå…¨ä¸è®Šï¼ˆç”¨ hash é©—è­‰ï¼‰
- **å¤±æ•—æ‡‰å°ï¼ˆPlan Bï¼‰**ï¼š
  - è‹¥ mtime ç„¡æ³•ä¿ç•™ï¼Œæ–‡ä»¶åŒ–æ­¤é™åˆ¶ä¸¦åœ¨ GUI è­¦å‘Š
  - æä¾›ã€Œåƒ…åŒç£ç¢Ÿæ¨¡å¼ã€é¸é …ï¼Œç¦æ­¢è·¨ç£ç¢Ÿæ“ä½œ
- **é æœŸæ™‚é–“**ï¼š0.5 å¤©

---

## 12. é–‹ç™¼è·¯ç·šåœ–
- **v0.1**ï¼šTkinter GUI + dry-run scan + thumbnail isolation + manifest åŸºç¤æ¶æ§‹
- **v0.2**ï¼šExact dedupeï¼ˆhashï¼šé è¨­ MD5ï¼Œå¯é¸ SHA-256ï¼‰ + reporting + åŒç£ç¢Ÿ move
- **v0.3**ï¼šè·¨ç£ç¢Ÿ copy æ¨¡å¼ + ä¸­æ–·æ¢å¾©æ©Ÿåˆ¶
- **v0.4**ï¼špHash clusteringï¼ˆå«æ€§èƒ½å„ªåŒ–ï¼‰+ keep-best-resolution policy
- **v0.5**ï¼šSynology renamingï¼ˆå››ä½æ•¸ suffixï¼‰+ year/month archiving
- **v0.6**ï¼šRollback åŠŸèƒ½ + è¡çªè™•ç†
- **v0.7**ï¼šä¸‰ç¨®æ¨¡å¼ï¼ˆFull / Rename-only / Archive-onlyï¼‰
- **v0.8**ï¼šé€²éš GUIï¼ˆé€²åº¦é¡¯ç¤ºã€é ä¼°æ™‚é–“ã€log å€ï¼‰
- **v0.9**ï¼šWindows exe æ‰“åŒ… + HEIC æ”¯æ´æ¸¬è©¦
- **v1.0**ï¼šå®Œæ•´æ¸¬è©¦ï¼ˆ25 çµ„ï¼‰+ æ–‡ä»¶åŒ– + éŒ¯èª¤è™•ç†å„ªåŒ–

---

## 13. å·²çŸ¥é™åˆ¶èˆ‡æ–‡ä»¶åŒ–
1. **Windows creation time**ï¼šè·¨ç£ç¢Ÿ copy å¾Œç„¡æ³•ä¿ç•™ï¼ˆç³»çµ±é™åˆ¶ï¼‰
2. **HEIC æ”¯æ´**ï¼šéœ€å®‰è£ libheif ç›¸é—œä¾è³´ï¼Œæ‰“åŒ…ç‚º exe å¾Œéœ€æ¸¬è©¦
3. **è·¨ç£ç¢Ÿç©ºé–“**ï¼šéœ€è¦èˆ‡ä¾†æºæª”æ¡ˆç¸½å’Œç›¸åŒçš„ç›®æ¨™ç©ºé–“
4. **pHash æ€§èƒ½**ï¼šè¶…é 5000 å¼µåœ–æ™‚å»ºè­°åˆ†æ‰¹è™•ç†
5. **æ™‚å€è³‡è¨Š**ï¼štimestamp ä¸å«æ™‚å€ï¼Œè·¨æ™‚å€ rollback æ™‚éœ€æ‰‹å‹•èª¿æ•´
6. **ç¬¦è™Ÿé€£çµ**ï¼šScan éšæ®µé‡åˆ° symlink/junction æ™‚**è·³éä¸æƒæ**ï¼Œè¨˜éŒ„ `SKIPPED_SYMLINK`ï¼ˆå«åŸå§‹è·¯å¾‘èˆ‡ç›®æ¨™è·¯å¾‘ï¼‰åˆ° logï¼Œä¸è¨ˆå…¥ä»»ä½•çµ±è¨ˆ
7. **ç¶²è·¯ç£ç¢Ÿ**ï¼šä¸å»ºè­°ä½¿ç”¨ï¼ˆæ€§èƒ½å·®ä¸”å¯èƒ½æœ‰æ¬Šé™å•é¡Œï¼‰
8. **é‡è·‘æ’é™¤**ï¼šScan è‡ªå‹•æ’é™¤ `Processed_*`ã€`TO_DELETE/`ã€`KEEP/`ã€`REPORT/` ç­‰è¼¸å‡ºç›®éŒ„

---

## 14. æŠ€è¡“ä¾è³´æ¸…å–®
### åŸ·è¡Œç’°å¢ƒéœ€æ±‚
- **Python ç‰ˆæœ¬**ï¼š3.10+ (å»ºè­° 3.11 æˆ– 3.12ï¼Œè¼ƒä½³æ•ˆèƒ½èˆ‡å‹åˆ¥æª¢æŸ¥)
- **Windows ç‰ˆæœ¬**ï¼šWindows 10 (1809+) æˆ– Windows 11
- **è¨˜æ†¶é«”å»ºè­°**ï¼š8 GB ä»¥ä¸Šï¼ˆè™•ç† 5000+ å¼µåœ–æ™‚å»ºè­° 16 GBï¼‰

### æ ¸å¿ƒ Python å¥—ä»¶
```txt
# å½±åƒè™•ç†
Pillow>=10.0.0           # åŸºç¤å½±åƒè™•ç†
pillow-heif>=0.13.0      # HEIC æ ¼å¼æ”¯æ´ï¼ˆéœ€ libheifï¼‰
imagehash>=4.3.1         # pHash è¨ˆç®—

# EXIF è®€å–
piexif>=1.1.3            # è¼•é‡ EXIF è®€å¯«
Pillow                   # å…§å»º EXIF è®€å–ï¼ˆå‚™ç”¨ï¼‰

# GUI
# Tkinterï¼ˆPython å…§å»ºï¼Œç„¡éœ€å®‰è£ï¼‰

# å·¥å…·
tqdm>=4.65.0             # é€²åº¦æ¢ï¼ˆCLI fallbackï¼‰
```

### æ‰“åŒ…å·¥å…·
```txt
PyInstaller>=5.10.0      # Windows exe æ‰“åŒ…
```

### é–‹ç™¼å·¥å…·ï¼ˆå¯é¸ï¼‰
```txt
pytest>=7.0.0            # å–®å…ƒæ¸¬è©¦
black>=23.0.0            # ç¨‹å¼ç¢¼æ ¼å¼åŒ–
mypy>=1.0.0              # éœæ…‹å‹åˆ¥æª¢æŸ¥
```

### å¤–éƒ¨ä¾è³´ï¼ˆWindowsï¼‰
- **libheif DLL**ï¼šé€é pillow-heif è‡ªå‹•è™•ç†ï¼ŒPyInstaller æ‰“åŒ…æ™‚éœ€é©—è­‰
- **Visual C++ Redistributable**ï¼šéƒ¨åˆ†ä½¿ç”¨è€…å¯èƒ½éœ€è¦å®‰è£ï¼ˆPillow ä¾è³´ï¼‰

### PyInstaller æ‰“åŒ…åƒæ•¸åƒè€ƒ
```bash
pyinstaller --onefile --windowed \
  --add-data "config.json;." \
  --hidden-import="PIL._tkinter_finder" \
  --collect-all pillow_heif \
  --icon=app_icon.ico \
  main.py
```

---

## 15. è¨­å®šæª”è¦æ ¼
### æª”æ¡ˆä½ç½®
- **ä½¿ç”¨è€…è¨­å®š**ï¼š`%APPDATA%/syno-photo-tidy/config.json`
- **é è¨­è¨­å®š**ï¼šç¨‹å¼å…§åµŒï¼Œé¦–æ¬¡åŸ·è¡Œæ™‚è‡ªå‹•ç”¢ç”Ÿä½¿ç”¨è€…è¨­å®šæª”

### config.json çµæ§‹
```json
{
  "version": "1.0",
  "last_updated": "2026-02-11T10:30:00",
  
  "hash": {
    "algorithm": "md5",
    "comment": "å¯é¸å€¼: md5 | sha256"
  },
  
  "phash": {
    "threshold": 8,
    "comment": "å»ºè­°ç¯„åœ 0-16ï¼Œå€¼è¶Šå°è¶Šåš´æ ¼",
    "max_images": 5000,
    "bucketing_strategy": "4-segment",
    "bucketing_comment": "å¯é¸å€¼: 2-segment | 4-segment | 8-segment"
  },
  
  "thumbnail": {
    "max_size_kb": 120,
    "max_dimension_px": 640,
    "min_dimension_px": 320,
    "comment": "ç¬¦åˆ (size<=120KB AND max_dim<=640) OR max_dim<=320 è¦–ç‚ºç¸®åœ–"
  },
  
  "performance": {
    "memory_limit_mb": 2048,
    "thread_pool_size": 4,
    "comment": "thread_pool ç”¨æ–¼ pHash è¨ˆç®—åŠ é€Ÿï¼ˆå¯¦é©—æ€§ï¼‰"
  },
  
  "ui": {
    "default_mode": "full-run",
    "auto_dry_run": true,
    "log_lines_display": 20,
    "comment": "GUI é è¨­è¡Œç‚ºè¨­å®š"
  },
  
  "advanced": {
    "skip_symlinks": true,
    "long_path_support": true,
    "comment": "Windows é•·è·¯å¾‘æ”¯æ´éœ€ç³»çµ±å•Ÿç”¨ï¼ˆgpedit.mscï¼‰"
  }
}
```

### è¨­å®šå„ªå…ˆé †åº
1. GUI å³æ™‚èª¿æ•´ï¼ˆæœ¬æ¬¡åŸ·è¡Œæœ‰æ•ˆï¼‰
2. ä½¿ç”¨è€…è¨­å®šæª”ï¼ˆ`%APPDATA%/config.json`ï¼‰
3. ç¨‹å¼é è¨­å€¼ï¼ˆå…§åµŒæ–¼ç¨‹å¼ç¢¼ï¼‰

### è¨­å®šé©—è­‰è¦å‰‡
- `phash.threshold`ï¼šå¿…é ˆ 0â€“16
- `phash.max_images`ï¼šå¿…é ˆ 100â€“50000
- `thumbnail.max_size_kb`ï¼šå¿…é ˆ 10â€“1000
- `thumbnail.max_dimension_px`ï¼šå¿…é ˆ 100â€“2000
- è‹¥è¨­å®šæª”æ ¼å¼éŒ¯èª¤æˆ–ç¼ºå¤±ï¼Œä½¿ç”¨é è¨­å€¼ä¸¦è¨˜éŒ„è­¦å‘Š

---

## 16. éŒ¯èª¤åˆ†é¡èˆ‡è™•ç†ç­–ç•¥
### éŒ¯èª¤ç­‰ç´šå®šç¾©
| ç­‰ç´š | ä»£ç¢¼ | è™•ç†æ–¹å¼ | ç¯„ä¾‹ |
|------|------|----------|------|
| ğŸ”´ Fatal | `E-xxx` | ç«‹å³ä¸­æ­¢æµç¨‹ | è¼¸å‡ºç›®éŒ„ç„¡å¯«å…¥æ¬Šé™ã€ç£ç¢Ÿç©ºé–“ä¸è¶³ |
| ğŸŸ¡ Recoverable | `W-xxx` | è·³éè©²æª”æ¡ˆä¸¦ç¹¼çºŒ | å–®ä¸€æª”æ¡ˆæ¬Šé™ä¸è¶³ã€HEIC è§£ç¢¼å¤±æ•— |
| ğŸŸ¢ Warning | `I-xxx` | è¨˜éŒ„ä½†ä¸å½±éŸ¿æµç¨‹ | EXIF ç¼ºå¤±ã€ç¬¦è™Ÿé€£çµè·³é |

### Fatal Errorsï¼ˆä¸­æ­¢æµç¨‹ï¼‰
| ä»£ç¢¼ | éŒ¯èª¤è¨Šæ¯ | è§¸ç™¼æ™‚æ©Ÿ |
|------|----------|----------|
| `E-001` | ä¾†æºè³‡æ–™å¤¾ä¸å­˜åœ¨æˆ–ç„¡è®€å–æ¬Šé™ | Phase 1 é–‹å§‹å‰ |
| `E-002` | è¼¸å‡ºç›®éŒ„ç„¡å¯«å…¥æ¬Šé™ | Phase 1 é–‹å§‹å‰ |
| `E-003` | ç£ç¢Ÿç©ºé–“ä¸è¶³ï¼ˆ< æª”æ¡ˆç¸½å’Œ + 10% bufferï¼‰ | dry-run éšæ®µæª¢æŸ¥ |
| `E-004` | manifest.jsonl å¯«å…¥å¤±æ•— | Phase 6 åŸ·è¡Œæ™‚ |
| `E-005` | è¨­å®šæª”æ ¼å¼éŒ¯èª¤ä¸”ç„¡æ³•ä½¿ç”¨é è¨­å€¼ | ç¨‹å¼å•Ÿå‹•æ™‚ |

### Recoverable Errorsï¼ˆè·³éä¸¦ç¹¼çºŒï¼‰
| ä»£ç¢¼ | éŒ¯èª¤è¨Šæ¯ | è™•ç†æ–¹å¼ |
|------|----------|----------|
| `W-101` | æª”æ¡ˆè®€å–æ¬Šé™è¢«æ‹’ | è¨˜éŒ„è‡³ error.logï¼Œè©²æª”æ¡ˆæ¨™è¨˜ `SKIPPED_PERMISSION` |
| `W-102` | åœ–ç‰‡è§£ç¢¼å¤±æ•—ï¼ˆææ¯€/ä¸æ”¯æ´æ ¼å¼ï¼‰ | è·³é resolution/pHashï¼Œä»å¯åƒèˆ‡ exact dedupe |
| `W-103` | HEIC è§£ç¢¼å¤±æ•—ï¼ˆlibheif ä¸å¯ç”¨ï¼‰ | è¨˜éŒ„ `UNSUPPORTED_HEIC`ï¼Œè·³é pHash |
| `W-104` | EXIF è®€å–å¤±æ•— | ä½¿ç”¨ `windows_created_time` fallback |
| `W-105` | æª”æ¡ˆç§»å‹•/è¤‡è£½å¤±æ•—ï¼ˆç›®æ¨™å·²å­˜åœ¨/é–å®šï¼‰ | è¨˜éŒ„è‡³ manifest ç‚º `status: failed`ï¼Œç¹¼çºŒè™•ç†å…¶ä»–æª”æ¡ˆ |
| `W-106` | è¶…é•·è·¯å¾‘ï¼ˆ> 260 å­—å…ƒä¸”æœªå•Ÿç”¨é•·è·¯å¾‘æ”¯æ´ï¼‰ | è·³éè©²æª”æ¡ˆä¸¦å»ºè­°å•Ÿç”¨ Windows é•·è·¯å¾‘æ”¯æ´ |

### Warningsï¼ˆåƒ…è¨˜éŒ„ï¼‰
| ä»£ç¢¼ | è¨Šæ¯ | èªªæ˜ |
|------|------|------|
| `I-201` | EXIF ç¼ºå¤±ï¼Œä½¿ç”¨ created_time | æ­£å¸¸æµç¨‹ï¼Œè¨˜éŒ„æ–¼ manifest |
| `I-202` | ç¬¦è™Ÿé€£çµå·²è·³é | è¨˜éŒ„ `SKIPPED_SYMLINK` åˆ° summary.txt |
| `I-203` | è·¨ç£ç¢Ÿæ“ä½œï¼Œä¾†æºä¿ç•™ | GUI é¡¯ç¤ºè­¦å‘Šï¼Œmanifest æ¨™è¨˜ `cross_drive: true` |
| `I-204` | æª”æ¡ˆæ•¸è¶…é pHash ä¸Šé™ï¼Œå·²è·³é Phase 4 | summary.txt é¡¯ç¤ºå»ºè­° |
| `I-205` | ç„¡ä»»ä½•å¯è™•ç†æª”æ¡ˆï¼ˆç©ºè³‡æ–™å¤¾æˆ–å…¨æ•¸è·³éï¼‰ | é¡¯ç¤º "No files found" |

### éŒ¯èª¤è™•ç†å¯¦ä½œ
```python
class ErrorLevel(Enum):
    FATAL = "E"
    RECOVERABLE = "W"
    WARNING = "I"

@dataclass
class ProcessError:
    code: str
    level: ErrorLevel
    message: str
    file_path: Optional[str] = None
    timestamp: str = field(default_factory=lambda: datetime.now().isoformat())

# ä½¿ç”¨ç¯„ä¾‹
try:
    img = Image.open(file_path)
except PermissionError:
    error = ProcessError("W-101", ErrorLevel.RECOVERABLE, f"Permission denied: {file_path}", file_path)
    log_error(error)
    continue  # è·³éè©²æª”æ¡ˆ
except Exception as e:
    error = ProcessError("W-102", ErrorLevel.RECOVERABLE, f"Image decode failed: {e}", file_path)
    log_error(error)
    file_info.resolution = None  # æ¨™è¨˜ç‚ºç„¡æ³•å–å¾—è§£æåº¦
```

### error.log æ ¼å¼
```
[2026-02-11 14:30:15] [W-101] Permission denied: C:\Photos\locked.jpg
[2026-02-11 14:30:16] [W-102] Image decode failed: cannot identify image file: C:\Photos\corrupt.jpg
[2026-02-11 14:31:00] [I-203] Cross-drive operation detected: C:\ â†’ D:\
```

---

## é™„éŒ„ï¼šå„ªå…ˆç´šæ’åºï¼ˆæ ¹æ“š review çµæœï¼‰
| å„ªå…ˆç´š | é …ç›® | ç‰ˆæœ¬ |
|--------|------|------|
| ğŸ”´ P0 | è·¨ç£ç¢Ÿ copy ç­–ç•¥ | v0.3 |
| ğŸ”´ P0 | pHash æ€§èƒ½å„ªåŒ– | v0.4 |
| ğŸŸ¡ P1 | ä¸­æ–·æ¢å¾©æ©Ÿåˆ¶ï¼ˆJSONL + partialï¼‰ | v0.3 |
| ğŸŸ¡ P1 | Mode B/C å¯¦ä½œ | v0.7 |
| ğŸŸ¢ P2 | æä¾› hash_algo åˆ‡æ›ï¼ˆmd5/sha256ï¼‰ | v0.2 |
| ğŸŸ¢ P2 | ç¸®åœ–é‚è¼¯æ˜ç¢ºåŒ– | v0.1 |
| ğŸŸ¢ P3 | æ™‚å€æ¨™è¨˜ | v0.1 |
| ğŸŸ¢ P3 | å››ä½æ•¸ suffix | v0.5 |

---

## 17. åŸ·è¡Œæª¢æŸ¥æ¸…å–®ï¼ˆPre-flight Checklistï¼‰
åœ¨é–‹å§‹é–‹ç™¼å‰ï¼Œç¢ºèªä»¥ä¸‹é …ç›®ï¼š

### ç’°å¢ƒæº–å‚™
- [ ] Python 3.10+ å·²å®‰è£ä¸¦è¨­å®š PATH
- [ ] å»ºç«‹è™›æ“¬ç’°å¢ƒï¼ˆ`python -m venv venv`ï¼‰
- [ ] å®‰è£æ‰€æœ‰ä¾è³´å¥—ä»¶ï¼ˆ`pip install -r requirements.txt`ï¼‰
- [ ] pillow-heif å¯æ­£å¸¸è¼‰å…¥ï¼ˆ`python -c "import pillow_heif; pillow_heif.register_heif_opener()"`ï¼‰

### POC é©—è­‰ï¼ˆå¿…é ˆå…¨éƒ¨é€šéï¼‰
- [ ] POC-1ï¼šHEIC æ‰“åŒ…æ¸¬è©¦é€šéï¼ˆæˆ–å·²åˆ¶å®š Plan Bï¼‰
- [ ] POC-2ï¼špHash æ€§èƒ½é”æ¨™ï¼ˆ< 5 åˆ†é˜/1000 å¼µï¼‰
- [ ] POC-3ï¼šè·¨ç£ç¢Ÿ copy æ­£ç¢ºæ€§é©—è­‰é€šé

### æ–‡ä»¶èˆ‡è¨­è¨ˆ
- [ ] å·²é–±è®€ä¸¦ç†è§£å®Œæ•´é–‹ç™¼è¨ˆç•«
- [ ] å·²ç”¢ç”Ÿé è¨­ `config.json` ä¸¦æ¸¬è©¦è¼‰å…¥
- [ ] å·²å»ºç«‹å°ˆæ¡ˆ Git repository
- [ ] å·²æº–å‚™æ¸¬è©¦ç”¨åœ–é›†ï¼ˆè‡³å°‘ 100 å¼µï¼Œå« HEIC/JPG/PNG/ç¸®åœ–/é‡è¤‡åœ–ï¼‰

### é–‹ç™¼å·¥å…·
- [ ] IDE è¨­å®šå®Œæˆï¼ˆVS Code + Python extensionï¼‰
- [ ] å·²è¨­å®š black/mypyï¼ˆå¯é¸ï¼‰
- [ ] å·²å»ºç«‹ pytest æ¸¬è©¦æ¡†æ¶éª¨æ¶

---

**æœ€å¾Œæ›´æ–°**ï¼š2026-02-11  
**ç‰ˆæœ¬**ï¼šv2.0ï¼ˆæ–°å¢æŠ€è¡“ä¾è³´ã€è¨­å®šæª”è¦æ ¼ã€éŒ¯èª¤åˆ†é¡ã€åŸ·è¡Œæª¢æŸ¥æ¸…å–®ï¼‰  
**ä¸‹ä¸€æ­¥**ï¼š
1. å®ŒæˆåŸ·è¡Œæª¢æŸ¥æ¸…å–®
2. åŸ·è¡ŒæŠ€è¡“é©—è­‰ POCï¼ˆ3 é …ï¼Œé è¨ˆ 2.5â€“3 å¤©ï¼‰
3. æ ¹æ“š POC çµæœèª¿æ•´è¨ˆç•«ï¼ˆç‰¹åˆ¥æ˜¯ pHash åˆ†æ¡¶ç­–ç•¥ï¼‰
4. é–‹å§‹ v0.1 é–‹ç™¼
